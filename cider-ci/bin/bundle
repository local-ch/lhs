#!/usr/bin/env bash
set -eux

export PATH=~/.rubies/$RUBY/bin:$PATH
rm -f .bundle/config

if [ ! -f ~/.rubies/$RUBY/bin/bundle ]; then
  gem install bundler
fi

# install bundler v. 1.17.3 in order to be able to run the tests with
# ACTIVESUPPORT=4 because rails (= 4.2.0) depends on bundler (< 2.0, >= 1.3.0)
gem install bundler:1.17.3

sed "s/^source 'https:\/\/rubygems\.intra\.local\.ch'*/source 'http\:\/\/52.29.7.59:9292'/g" Gemfile > Gemfile.tmp
mv Gemfile.tmp Gemfile

DIGEST=$(git ls-tree HEAD --\
  cider-ci.yml cider-ci Gemfile.lock \
  | openssl dgst -sha1 | cut -d ' ' -f 2)

if [ ! -z ${ACTIVESUPPORT:-} ]; then
  DIGEST=$(echo "$DIGEST $ACTIVESUPPORT")
fi

DIGEST=$(echo "$DIGEST $PATH" \
 | openssl dgst -sha1 | cut -d ' ' -f 2)

echo "DIGEST"
echo "${DIGEST}"

CACHE_SIGNATURE_FILE="/tmp/bundle_cache_signature_${DIGEST}"

if [ ! -f  $CACHE_SIGNATURE_FILE ] ; then
  if [ ! -z ${ACTIVESUPPORT:-} ]; then
    if [ ! -z ${BUNDLER:-} ]; then
      echo "BUNDLE_GEMFILE=Gemfile.activesupport$ACTIVESUPPORT bundle $BUNDLER install"
      BUNDLE_GEMFILE=Gemfile.activesupport$ACTIVESUPPORT bundle $BUNDLER install
    else
      echo "BUNDLE_GEMFILE=Gemfile.activesupport$ACTIVESUPPORT bundle install"
      BUNDLE_GEMFILE=Gemfile.activesupport$ACTIVESUPPORT bundle install
    fi
  else
    echo "bundle install"
    bundle $BUNDLER install
  fi
  touch $CACHE_SIGNATURE_FILE
fi

echo "bundle install"
bundle $BUNDLER install
