#!/usr/bin/env bash
set -eux

export PATH=~/.rubies/$RUBY/bin:$PATH
rm -f .bundle/config

if [ ! -f ~/.rubies/$RUBY/bin/bundle ]; then
  gem install bundler
fi

sed "s/^source 'https:\/\/rubygems\.intra\.local\.ch'*/source 'http\:\/\/52.29.7.59:9292'/g" Gemfile > Gemfile.tmp
mv Gemfile.tmp Gemfile

DIGEST=$(git ls-tree HEAD --\
  cider-ci.yml cider-ci Gemfile.lock \
  | openssl dgst -sha1 | cut -d ' ' -f 2)

if [ -z "${ACTIVESUPPORT+1}" ]; then 
  DIGEST=$(echo "$DIGEST $ACTIVESUPPORT")
fi

DIGEST=$(echo "$DIGEST $PATH" \
 | openssl dgst -sha1 | cut -d ' ' -f 2)

CACHE_SIGNATURE_FILE="/tmp/bundle_cache_signature_${DIGEST}"

echo "ACTIVESUPPORT $ACTIVESUPPORT";

if [ ! -f  $CACHE_SIGNATURE_FILE ] ; then
  echo "COMMAND: BUNDLE_GEMFILE=Gemfile.activesupport$ACTIVESUPPORT bundle install"
  if [ -z "${ACTIVESUPPORT+1}" ]; then BUNDLE_GEMFILE=Gemfile.activesupport$ACTIVESUPPORT bundle install; else bundle install; fi
  touch $CACHE_SIGNATURE_FILE
fi

